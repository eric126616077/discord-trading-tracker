<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·Ÿå–®åŠ©æ‰‹ - äº¤æ˜“è¨Šè™Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a2e;
            color: #eaeaea;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            color: #00d9ff;
            font-size: 2em;
        }
        
        .header p {
            color: #888;
            margin-top: 5px;
        }
        
        .time-info {
            display: flex;
            gap: 20px;
        }
        
        .time-box {
            text-align: center;
            padding: 10px 20px;
            background: rgba(0, 217, 255, 0.1);
            border-radius: 10px;
        }
        
        .time-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #00d9ff;
        }
        
        .time-label {
            font-size: 0.8em;
            color: #888;
        }
        
        .action-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #00b8d9);
            color: #1a1a2e;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
        }
        
        .sound-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: #16213e;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .sound-icon { font-size: 1.5em; }
        
        .sound-toggle.enabled { border: 2px solid #4CAF50; }
        .sound-toggle.disabled { border: 2px solid #f44336; }
        
        .refresh-info {
            color: #666;
            font-size: 0.9em;
            margin-left: auto;
        }
        
        /* ===== è¨Šè™Ÿåˆ—è¡¨ ===== */
        .signals-section {
            background: #16213e;
            border-radius: 16px;
            padding: 25px;
        }
        
        .section-title {
            font-size: 1.5em;
            color: #00d9ff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .signal-list {
            height: auto;
            overflow: visible;
        }
        
        .signal-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid;
            transition: transform 0.2s;
        }
        
        .signal-card:hover {
            transform: translateX(5px);
        }
        
        /* è²·å…¥é‚Šæ¡† */
        .signal-card.buy {
            border-left-color: #4CAF50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.2);
        }
        
        /* è³£å‡ºé‚Šæ¡† */
        .signal-card.sell {
            border-left-color: #f44336;
            box-shadow: 0 0 15px rgba(244, 67, 54, 0.2);
        }
        
        /* æ­¢ç›ˆé‚Šæ¡† */
        .signal-card.profit {
            border-left-color: #4CAF50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }
        
        /* æ­¢æé‚Šæ¡† */
        .signal-card.loss {
            border-left-color: #f44336;
            box-shadow: 0 0 15px rgba(244, 67, 54, 0.3);
        }
        
        /* ä¸€èˆ¬è¨Šæ¯ */
        .signal-card.info {
            border-left-color: #2196F3;
        }
        
        /* tuk é »é“ - ç´«è‰² */
        .signal-card.channel-tuk {
            border-left-color: #9C27B0;
            box-shadow: 0 0 15px rgba(156, 39, 176, 0.3);
        }
        
        /* oculus é »é“ - é’è—è‰² */
        .signal-card.channel-oculus {
            border-left-color: #00BCD4;
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.3);
        }
        
        /* jpm é »é“ - é‡‘è‰² */
        .signal-card.channel-jpm {
            border-left-color: #FF9800;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.3);
        }
        
        /* é »é“æ¨™ç±¤é¡è‰² */
        .channel-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
            color: white;
            margin-left: 8px;
        }
        
        .channel-tag-tuk {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
        }
        
        .channel-tag-oculus {
            background: linear-gradient(135deg, #00BCD4, #0097A7);
        }
        
        .channel-tag-jpm {
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }
        
        /* ä¿¡æ¯æµåˆ‡æ›æ¨™ç±¤ */
        .stream-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: rgba(22, 33, 62, 0.8);
            border-radius: 12px;
        }
        
        .stream-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: 2px solid transparent;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.05);
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stream-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .stream-tab.active {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }
        
        .stream-tab[data-channel="tuk"].active {
            border-color: #9C27B0;
            box-shadow: 0 0 15px rgba(156, 39, 176, 0.4);
        }
        
        .stream-tab[data-channel="oculus"].active {
            border-color: #00BCD4;
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.4);
        }
        
        .stream-tab[data-channel="jpm"].active {
            border-color: #FF9800;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.4);
        }
        
        .stream-tab[data-channel="all"].active {
            border-color: #4CAF50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
        }
        
        .stream-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
        }
        
        .stream-avatar.tuk {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
        }
        
        .stream-avatar.oculus {
            background: linear-gradient(135deg, #00BCD4, #0097A7);
        }
        
        .stream-avatar.jpm {
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }
        
        .stream-avatar.all {
            background: linear-gradient(135deg, #4CAF50, #388E3C);
        }
        
        .stream-name {
            font-weight: 600;
            font-size: 0.95em;
        }
        
        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .signal-meta {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .signal-time {
            font-size: 0.95em;
            color: #888;
        }
        
        /* å‹•ä½œæ¨™ç±¤ */
        .action-tag {
            font-size: 1.1em;
            font-weight: bold;
            padding: 8px 18px;
            border-radius: 8px;
        }
        
        .action-tag.buy {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        .action-tag.sell {
            background: linear-gradient(135deg, #f44336, #C62828);
            color: white;
        }
        
        .action-tag.profit {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        .action-tag.loss {
            background: linear-gradient(135deg, #f44336, #C62828);
            color: white;
        }
        
        .action-tag.info {
            background: linear-gradient(135deg, #2196F3, #1565C0);
            color: white;
        }
        
        /* ===== è§£æçµæœ ===== */
        .parsed-result {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .parsed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .parsed-ticker {
            font-size: 2em;
            font-weight: bold;
        }
        
        .parsed-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .detail-box {
            text-align: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .detail-label {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-size: 1.4em;
            font-weight: bold;
        }
        
        .detail-value.green { color: #4CAF50; }
        .detail-value.red { color: #f44336; }
        .detail-value.blue { color: #00d9ff; }
        .detail-value.white { color: #fff; }
        
        .detail-value.call { color: #4CAF50; }
        .detail-value.put { color: #f44336; }
        
        /* ===== åŸå§‹æ•¸æ“š ===== */
        .raw-data {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 10px;
            padding: 15px;
        }
        
        .raw-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .raw-title {
            color: #2196F3;
            font-weight: bold;
            font-size: 0.95em;
        }
        
        .raw-content {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #b0bec5;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            overflow: visible;
        }
        
        .raw-content.collapsed {
            display: none;
        }
        
        /* æ–°è¨Šæ¯é–ƒçˆ */
        @keyframes flash-new {
            0%, 100% { 
                background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%); 
                box-shadow: 0 0 5px rgba(0, 217, 255, 0.3);
            }
            50% { 
                background: linear-gradient(135deg, #2a3a4e 0%, #1a2a3e 100%); 
                box-shadow: 0 0 20px rgba(0, 217, 255, 0.6);
            }
        }
        
        /* TUK æœªè®€é–ƒçˆ - ç´«è‰² */
        @keyframes flash-tuk {
            0% { background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%); box-shadow: 0 0 5px rgba(156, 39, 176, 0.3); }
            50% { background: linear-gradient(135deg, #2a1a3e 0%, #1a0f2e 100%); box-shadow: 0 0 25px rgba(156, 39, 176, 0.7); }
            100% { background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%); box-shadow: 0 0 5px rgba(156, 39, 176, 0.3); }
        }
        
        /* OCULUS æœªè®€é–ƒçˆ - é’è—è‰² */
        @keyframes flash-oculus {
            0% { background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%); box-shadow: 0 0 5px rgba(0, 188, 212, 0.3); }
            50% { background: linear-gradient(135deg, #1a2a3e 0%, #0f1a2e 100%); box-shadow: 0 0 25px rgba(0, 188, 212, 0.7); }
            100% { background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%); box-shadow: 0 0 5px rgba(0, 188, 212, 0.3); }
        }
        
        /* JPM æœªè®€é–ƒçˆ - æ©™è‰² */
        @keyframes flash-jpm {
            0% { background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%); box-shadow: 0 0 5px rgba(255, 152, 0, 0.3); }
            50% { background: linear-gradient(135deg, #2a2a1e 0%, #1a1a0f 100%); box-shadow: 0 0 25px rgba(255, 152, 0, 0.7); }
            100% { background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%); box-shadow: 0 0 5px rgba(255, 152, 0, 0.3); }
        }
        
        /* é€šç”¨æœªè®€é–ƒçˆ */
        .signal-card.new {
            animation: flash-new 1.5s ease-in-out infinite;
            border: 2px solid rgba(0, 217, 255, 0.5);
        }
        
        /* TUK æœªè®€æ¨£å¼ */
        .signal-card.channel-tuk.new {
            animation: flash-tuk 1.5s ease-in-out infinite;
            border: 2px solid rgba(156, 39, 176, 0.6);
        }
        
        /* OCULUS æœªè®€æ¨£å¼ */
        .signal-card.channel-oculus.new {
            animation: flash-oculus 1.5s ease-in-out infinite;
            border: 2px solid rgba(0, 188, 212, 0.6);
        }
        
        /* JPM æœªè®€æ¨£å¼ */
        .signal-card.channel-jpm.new {
            animation: flash-jpm 1.5s ease-in-out infinite;
            border: 2px solid rgba(255, 152, 0, 0.6);
        }
        
        /* å·±è®€å¾Œçš„å¡ç‰‡æ¨£å¼ */
        .signal-card.read {
            opacity: 0.85;
        }
        
        /* é»æ“Šæç¤º */
        .click-hint {
            font-size: 0.75em;
            color: #00d9ff;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        
        /* å·±è®€æŒ‰éˆ•æ¨£å¼ */
        .btn-read {
            padding: 6px 14px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-read:hover {
            background: linear-gradient(135deg, #66BB6A, #43A047);
            transform: scale(1.05);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* ç¯©é¸æŒ‰éˆ• */
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            background: #16213e;
            border: 2px solid transparent;
            border-radius: 8px;
            color: #eaeaea;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .filter-btn:hover {
            border-color: #00d9ff;
        }
        
        .filter-btn.active {
            background: #00d9ff;
            color: #1a1a2e;
        }
        
        .no-signals {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        
        .no-signals-icon { font-size: 4em; margin-bottom: 20px; }
        
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .parsed-details { grid-template-columns: repeat(2, 1fr); }
            .parsed-ticker { font-size: 1.5em; }
            .signal-header { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>è·Ÿå–®åŠ©æ‰‹</h1>
                <p>åˆä½µæ‰€æœ‰é »é“ Â· é¡¯ç¤ºåŸå§‹æ•¸æ“š</p>
            </div>
            <div class="time-info">
                <div class="time-box">
                    <div class="time-value" id="macau-time">--:--</div>
                    <div class="time-label">æ¾³é–€æ™‚é–“</div>
                </div>
                <div class="time-box">
                    <div class="time-value" id="us-time">--:--</div>
                    <div class="time-label">ç¾åœ‹æ™‚é–“</div>
                </div>
            </div>
        </div>
        
        <!-- ä¸‰å€‹ç¨ç«‹ä¿¡æ¯æµåˆ‡æ› -->
        <div class="stream-tabs">
            <button class="stream-tab active" data-channel="tuk" onclick="setStream('tuk', this)">
                <span class="stream-avatar tuk">T</span>
                <span class="stream-name">TUK</span>
            </button>
            <button class="stream-tab" data-channel="oculus" onclick="setStream('oculus', this)">
                <span class="stream-avatar oculus">O</span>
                <span class="stream-name">OCULUS</span>
            </button>
            <button class="stream-tab" data-channel="jpm" onclick="setStream('jpm', this)">
                <span class="stream-avatar jpm">J</span>
                <span class="stream-name">JPM</span>
            </button>
            <button class="stream-tab" data-channel="all" onclick="setStream('all', this)">
                <span class="stream-avatar all">ğŸ“Š</span>
                <span class="stream-name">å…¨éƒ¨</span>
            </button>
        </div>
        
        <div class="action-bar">
            <button class="btn btn-primary" onclick="fetchData()">åˆ·æ–°</button>
            <button class="btn btn-success" onclick="testSound()">æ¸¬è©¦è²éŸ³</button>
            <button class="btn btn-warning" onclick="markAllAsRead()">âœ“ å…¨éƒ¨å·±è®€</button>
            <div class="sound-toggle enabled" id="sound-toggle" onclick="toggleSound()">
                <span class="sound-icon" id="sound-icon">ğŸ””</span>
                <span id="sound-status">é–‹</span>
            </div>
            <a href="/debug" class="btn btn-warning">èª¿è©¦</a>
            <span class="refresh-info" id="last-update">--</span>
        </div>
        
        <div class="filter-bar">
            <button class="filter-btn active" onclick="setFilter('all', this)">å…¨éƒ¨</button>
            <button class="filter-btn" onclick="setFilter('buy', this)">è²·å…¥</button>
            <button class="filter-btn" onclick="setFilter('sell', this)">è³£å‡º</button>
            <button class="filter-btn" onclick="setFilter('profit', this)">æ­¢ç›ˆ</button>
            <button class="filter-btn" onclick="setFilter('loss', this)">æ­¢æ</button>
        </div>
        
        <div class="signals-section">
            <div class="section-title">è¨Šè™Ÿæµ</div>
            <div class="signal-list" id="signal-list">
                <div class="no-signals">
                    <div class="no-signals-icon">ğŸ“­</div>
                    <h3>ç­‰å¾…è¨Šè™Ÿ...</h3>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // èª¿è©¦é–‹é—œ (true = é–‹å•Ÿ, false = é—œé–‰)
        const DEBUG = true;
        
        // é »é“ ID å°æ‡‰åç¨±
        const CHANNEL_NAMES = {
            '1454140095442583715': 'tuk',
            '1459878042955677869': 'oculus',
            '1458011589624987699': 'jpm'
        };
        
        // å…¨åŸŸè®Šé‡å®šç¾©
        let messages = [];
        let currentFilter = 'all';
        let currentStream = 'all'; // ç•¶å‰é¸æ“‡çš„ä¿¡æ¯æµ: 'tuk', 'oculus', 'jpm', 'all'
        let soundEnabled = true;
        let lastMessageCount = 0;
        let readIds = new Set(); // å·²è®€è¨Šæ¯IDé›†åˆ
        
        function getChannelName(channelId) {
            return CHANNEL_NAMES[channelId] || channelId || 'æœªçŸ¥é »é“';
        }
        
        function getChannelClass(channelId) {
            const name = CHANNEL_NAMES[channelId];
            if (name) return 'channel-' + name;
            return '';
        }
        
        // è¿½è¹¤æ¯å€‹é »é“çš„æœ€å¾Œçœ‹åˆ°è¨Šæ¯æ™‚é–“æˆ³
        let lastSeenPerStream = {
            'tuk': null,
            'oculus': null,
            'jpm': null,
            'all': null
        };
        
        // ä¿¡æ¯æµåˆ‡æ›
        function setStream(stream, btn) {
            currentStream = stream;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.stream-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            // é‡æ–°æ¸²æŸ“
            renderMessages();
            
            // åœæ­¢éˆ´è²ï¼ˆåˆ‡æ›é »é“æ™‚é‡æ–°ç›£æ§ï¼‰
            stopNotificationSound();
            
            // é‡ç½®è©²é »é“çš„å·²è®€ç‹€æ…‹ï¼Œè®“æ–°è¨Šæ¯å¯ä»¥å†æ¬¡è§¸ç™¼éˆ´è²
            lastSeenPerStream[stream] = null;
            
            // æ¨™è¨˜è©²æµçš„æ‰€æœ‰è¨Šæ¯ç‚ºå·²è®€
            const channelNames = stream === 'all' ? ['tuk', 'oculus', 'jpm'] : [stream];
            messages.forEach(m => {
                const channelName = CHANNEL_NAMES[m.channel_id];
                if (channelNames.includes(channelName)) {
                    const msgId = m.id || 'msg-' + messages.indexOf(m);
                    readIds.add(msgId);
                }
            });
        }
        
        // è²·å…¥éŸ³æ•ˆ - ä¸Šå‡éŸ³
        function playBuySound() {
            if (!soundEnabled) return;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            osc.frequency.setValueAtTime(523, ctx.currentTime);
            osc.frequency.setValueAtTime(659, ctx.currentTime + 0.1);
            osc.frequency.setValueAtTime(784, ctx.currentTime + 0.2);
            
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
            
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.4);
        }
        
        // è³£å‡ºéŸ³æ•ˆ - ä¸‹é™éŸ³
        function playSellSound() {
            if (!soundEnabled) return;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            osc.frequency.setValueAtTime(440, ctx.currentTime);
            osc.frequency.setValueAtTime(349, ctx.currentTime + 0.1);
            osc.frequency.setValueAtTime(262, ctx.currentTime + 0.2);
            
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
            
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.4);
        }
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const toggle = document.getElementById('sound-toggle');
            const icon = document.getElementById('sound-icon');
            const status = document.getElementById('sound-status');
            
            if (soundEnabled) {
                toggle.className = 'sound-toggle enabled';
                icon.textContent = 'ğŸ””';
                status.textContent = 'é–‹';
            } else {
                toggle.className = 'sound-toggle disabled';
                icon.textContent = 'ğŸ”•';
                status.textContent = 'é—œ';
            }
        }

        // ============ æ–°è¨Šæ¯ç›£æ§ï¼ˆå®¢æˆ¶ç«¯éŸ³æ•ˆï¼‰============
        
        let notificationSoundInterval = null;  // éˆ´è²å¾ªç’°

        // æ’­æ”¾é€šçŸ¥éˆ´è²ï¼ˆå—¶å—¶å—¶ï¼‰
        function playNotificationSound() {
            if (!soundEnabled) return;
            
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            // å—¶å—¶å—¶æ¨¡å¼
            osc.type = 'square';
            osc.frequency.setValueAtTime(1000, ctx.currentTime);
            
            // å—¶è² 200msï¼Œä¼‘æ¯ 150msï¼Œé‡è¤‡
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.2);
        }

        // åœæ­¢é€šçŸ¥éˆ´è²
        function stopNotificationSound() {
            if (notificationSoundInterval) {
                clearInterval(notificationSoundInterval);
                notificationSoundInterval = null;
            }
        }

        // æª¢æŸ¥æ–°è¨Šæ¯ä¸¦æ’­æ”¾éˆ´è²ï¼ˆæŒ‰é »é“ç›£æ§ï¼‰
        async function checkNewMessages() {
            try {
                const response = await fetch('/api/messages/latest');
                const data = await response.json();
                
                if (data.has_new && messages.length > 0) {
                    const latestMsg = messages[0];  // æœ€æ–°è¨Šæ¯
                    const msgChannelId = latestMsg.channel_id;
                    const msgChannelName = CHANNEL_NAMES[msgChannelId] || msgChannelId;
                    
                    // åˆ¤æ–·æ˜¯å¦æ‡‰è©²æ’­æ”¾éˆ´è²
                    let shouldAlert = false;
                    
                    if (currentStream === 'all') {
                        // å…¨éƒ¨æ¨¡å¼ï¼šåªæœ‰æœªè®€è¨Šæ¯æ‰æé†’
                        const msgId = latestMsg.id || 'msg-0';
                        if (!readIds.has(msgId)) {
                            shouldAlert = true;
                        }
                    } else {
                        // å–®é »é“æ¨¡å¼ï¼šæª¢æŸ¥æ–°è¨Šæ¯æ˜¯å¦ä¾†è‡ªç•¶å‰é »é“
                        if (msgChannelName === currentStream) {
                            // æª¢æŸ¥é€™å€‹é »é“æ˜¯å¦æœ‰æœªè®€è¨Šæ¯
                            const unreadInStream = messages.filter(m => {
                                const channelName = CHANNEL_NAMES[m.channel_id];
                                return channelName === currentStream;
                            }).filter(m => {
                                const mid = m.id || 'msg-' + messages.indexOf(m);
                                return !readIds.has(mid);
                            });
                            
                            if (unreadInStream.length > 0) {
                                shouldAlert = true;
                            }
                        }
                    }
                    
                    // æ’­æ”¾éˆ´è²
                    if (shouldAlert && soundEnabled) {
                        playNotificationSound();
                        
                        // é–‹å§‹æŒçºŒæ’­æ”¾éˆ´è²ï¼ˆæ¯ 1.5 ç§’ï¼‰
                        if (!notificationSoundInterval) {
                            notificationSoundInterval = setInterval(() => {
                                // é‡æ–°æª¢æŸ¥æ˜¯å¦é‚„æœ‰æœªè®€
                                let stillHasUnread = false;
                                
                                if (currentStream === 'all') {
                                    stillHasUnread = messages.some(m => {
                                        const mid = m.id || 'msg-' + messages.indexOf(m);
                                        return !readIds.has(mid);
                                    });
                                } else {
                                    stillHasUnread = messages.some(m => {
                                        const channelName = CHANNEL_NAMES[m.channel_id];
                                        if (channelName !== currentStream) return false;
                                        const mid = m.id || 'msg-' + messages.indexOf(m);
                                        return !readIds.has(mid);
                                    });
                                }
                                
                                if (stillHasUnread && soundEnabled) {
                                    playNotificationSound();
                                } else {
                                    stopNotificationSound();
                                }
                            }, 1500);
                        }
                    } else if (!shouldAlert) {
                        stopNotificationSound();
                    }
                }
            } catch (e) {
                console.log('æª¢æŸ¥æ–°è¨Šæ¯å¤±æ•—:', e);
            }
        }

        // é–‹å§‹ç›£æ§æ–°è¨Šæ¯
        function startMessageMonitoring() {
            // æ¯ 3 ç§’æª¢æŸ¥ä¸€æ¬¡æ–°è¨Šæ¯
            setInterval(checkNewMessages, 3000);
        }

        // æ¨™è¨˜è¨Šæ¯ç‚ºå·±è®€
        async function markAsRead(msgId) {
            if (!readIds.has(msgId)) {
                readIds.add(msgId);
                const card = document.getElementById('card-' + msgId);
                if (card) {
                    card.classList.remove('new');
                    card.classList.add('read');
                }
                // ç§»é™¤æç¤ºæ–‡å­—
                const hint = document.getElementById('hint-' + msgId);
                if (hint) hint.remove();

                // æª¢æŸ¥ç•¶å‰è¦–åœ–æ˜¯å¦é‚„æœ‰æœªè®€è¨Šæ¯
                let hasUnread = false;
                
                if (currentStream === 'all') {
                    hasUnread = messages.some(m => {
                        const mid = m.id || 'msg-' + messages.indexOf(m);
                        return !readIds.has(mid);
                    });
                } else {
                    hasUnread = messages.some(m => {
                        const channelName = CHANNEL_NAMES[m.channel_id];
                        if (channelName !== currentStream) return false;
                        const mid = m.id || 'msg-' + messages.indexOf(m);
                        return !readIds.has(mid);
                    });
                }

                if (!hasUnread) {
                    stopNotificationSound();  // åœæ­¢å®¢æˆ¶ç«¯éˆ´è²
                }
            }
        }

        // æ¨™è¨˜æ‰€æœ‰ç‚ºå·±è®€
        async function markAllAsRead() {
            messages.forEach(m => {
                const msgId = m.id || 'msg-' + messages.indexOf(m);
                markAsRead(msgId);
            });
            // åœæ­¢éˆ´è²
            stopNotificationSound();
        }
        
        function testSound() {
            playBuySound();
            setTimeout(playSellSound, 500);
        }
        
        function setFilter(filter, btn) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderMessages();
        }
        
        async function fetchData() {
            try {
                const response = await fetch('/api/trading/messages?limit=200');
                const data = await response.json();
                
                const newCount = data.messages?.length || 0;
                if (newCount > lastMessageCount && lastMessageCount > 0 && messages.length > 0) {
                    const latestMsg = data.messages[0];
                    if (latestMsg.has_order) {
                        const info = parseMessage(latestMsg.content);
                        if (info.action === 'buy') {
                            playBuySound();
                        } else {
                            playSellSound();
                        }
                    }
                }
                lastMessageCount = newCount;
                
                messages = data.messages || [];
                
                // æ¨™è¨˜æ–°è¨Šæ¯ï¼ˆåªå°ç•¶å‰ä¿¡æ¯æµé–ƒçˆï¼‰
                messages.forEach(m => {
                    const msgId = m.id || 'msg-' + messages.indexOf(m);
                    const channelName = CHANNEL_NAMES[m.channel_id];
                    
                    // æª¢æŸ¥è¨Šæ¯æ˜¯å¦å±¬æ–¼ç•¶å‰é¸æ“‡çš„ä¿¡æ¯æµ
                    const isCurrentStream = currentStream === 'all' || channelName === currentStream;
                    
                    // æ‰¾å‡ºè©²ä¿¡æ¯æµä¸­è¨Šæ¯çš„ç´¢å¼•
                    const streamMessages = messages.filter(msg => {
                        const cn = CHANNEL_NAMES[msg.channel_id];
                        return currentStream === 'all' || cn === currentStream;
                    });
                    const streamIndex = streamMessages.indexOf(m);
                    
                    if (isCurrentStream && streamIndex < 5 && !readIds.has(msgId)) {
                        // ç•¶å‰æµçš„æœ€æ–°5æ¢ï¼Œä¿æŒæœªè®€ç‹€æ…‹ï¼ˆæœƒé–ƒçˆï¼‰
                    } else {
                        readIds.add(msgId); // å…¶ä»–è¨Šæ¯æ¨™ç‚ºå·²è®€
                    }
                });
                
                // æ›´æ–°çµ±è¨ˆï¼ˆå·²ç§»é™¤ï¼‰
                
                updateTimes();
                renderMessages();
                
                document.getElementById('last-update').textContent = 
                    'æ›´æ–°: ' + new Date().toLocaleTimeString('zh-TW');
                
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function updateTimes() {
            const now = new Date();
            const macau = new Date(now.toLocaleString('en-US', {timeZone: 'Asia/Macau'}));
            const us = new Date(now.toLocaleString('en-US', {timeZone: 'America/New_York'}));
            
            document.getElementById('macau-time').textContent = 
                macau.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('us-time').textContent = 
                us.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
        }
        
        function parseMessage(content) {
            content = content || '';
            const lower = content.toLowerCase();
            
            if (DEBUG) console.log('[è§£æ] å…§å®¹:', content.substring(0, 100), '| é•·åº¦:', content.length);
            
            // ========== 1. æª¢æ¸¬ OCULUS Embed æ ¼å¼ ==========
            // Ticker | $SPX, Strike | 6980C, Expiry | 0dte, Entry | 2.10
            const embedTicker = content.match(/(?:Ticker|è‚¡ç¥¨ä»£ç )\s*[|]\s*\$?([A-Z]{2,})/i);
            const embedStrike = content.match(/(?:Strike|è¡Œæƒä»·)\s*[|]\s*(\d+)([pcCP])/i);
            if (embedTicker && embedStrike && embedTicker[1] !== 'OCULUS') {
                const ticker = embedTicker[1].toUpperCase();
                const embedEntry = content.match(/(?:Entry|å…¥åœº|å…¥å ´)\s*[|]\s*\$?([\d.]+)/i);
                const embedExpiry = content.match(/(?:Expiry|åˆ°æœŸæ—¥)\s*[|]\s*(\d{1,2}\/\d{1,2}|0dte)/i);
                
                let expiration = '';
                if (embedExpiry) {
                    if (embedExpiry[1].toLowerCase().includes('0dte')) {
                        const today = new Date();
                        expiration = `${today.getMonth()+1}/${today.getDate()} (ä»Šå¤©åˆ°æœŸ)`;
                    } else {
                        expiration = embedExpiry[1];
                    }
                }
                
                const isLotto = /Lotto|å½©ç¥¨/i.test(content);
                const result = {
                    ticker,
                    strikePrice: embedStrike[1],
                    optionType: embedStrike[2].toUpperCase(),
                    price: embedEntry ? embedEntry[1] : '',
                    action: 'buy',
                    actionText: 'ğŸŸ¢ è²·å…¥' + (isLotto ? ' ğŸ°' : ''),
                    expiration: expiration + (isLotto ? ' âš ï¸é«˜é¢¨éšª' : '')
                };
                if (DEBUG) console.log('[çµæœ] OCULUS Embed:', result);
                return result;
            }
            
            // ========== 2. æª¢æ¸¬ OCULUS ä¸€èˆ¬æ ¼å¼ ==========
            // Ticker: $QQQ, Strike: 64C, Expiry: 2/11, Entry: 1.61
            const oculusTicker = content.match(/Ticker\s*[:=]?\s*\$([A-Z]{2,})/i) || content.match(/è‚¡ç¥¨ä»£ç \s*[:=]?\s*\$([A-Z]{2,})/i);
            const oculusStrike = content.match(/(?:Strike|è¡Œæƒä»·)\s*[:=]?\s*(\d+)([pcCP])/i);
            if (oculusTicker && oculusStrike) {
                const ticker = oculusTicker[1].toUpperCase();
                const oculusEntry = content.match(/(?:Entry|å…¥åœº|å…¥å ´)\s*[:=]?\s*\$?([\d.]+)/i);
                const oculusExpiry = content.match(/(?:Expiry|åˆ°æœŸæ—¥)\s*[:=]?\s*(\d{1,2}\/\d{1,2}|0dte)/i);
                
                let expiration = '';
                if (oculusExpiry) {
                    if (oculusExpiry[1].toLowerCase().includes('0dte')) {
                        const today = new Date();
                        expiration = `${today.getMonth()+1}/${today.getDate()} (ä»Šå¤©åˆ°æœŸ)`;
                    } else {
                        expiration = oculusExpiry[1];
                    }
                }
                
                const isLotto = /Lotto|å½©ç¥¨/i.test(content);
                const result = {
                    ticker,
                    strikePrice: oculusStrike[1],
                    optionType: oculusStrike[2].toUpperCase(),
                    price: oculusEntry ? oculusEntry[1] : '',
                    action: 'buy',
                    actionText: 'ğŸŸ¢ è²·å…¥' + (isLotto ? ' ğŸ°' : ''),
                    expiration: expiration + (isLotto ? ' âš ï¸é«˜é¢¨éšª' : '')
                };
                if (DEBUG) console.log('[çµæœ] OCULUS ä¸€èˆ¬:', result);
                return result;
            }
            
            // ========== 3. æª¢æ¸¬ BTO è²·å…¥æ ¼å¼ (åŒ…å«å‰ç¶´) ==========
            // æ ¼å¼: BTO $QQQ 630c 01, BTO $QQQ 613p 02/10 @0.69, $QQQ 630c 01, TSLA 437.5c
            // ä½¿ç”¨å…¨å±€æœç´¢æ‰¾åˆ°å…§å®¹ä¸­çš„æ¨¡å¼
            const btoPattern = /(?:BTO\s+\$?|[\$\s]|^)([A-Z]{2,})\s+(\d+\.?\d*)([PpCc])\s*(\d{1,2}(?:\/\d{1,2})?)/i;
            const btoMatch = content.match(btoPattern);
            
            if (btoMatch) {
                const ticker = btoMatch[1].toUpperCase();
                const strikePrice = btoMatch[2];
                const optionType = btoMatch[3].toUpperCase();
                const expiry = btoMatch[4];
                
                // è§£æåƒ¹æ ¼ (@åƒ¹æ ¼)
                const priceMatch = content.match(/@\$?([\d.]+)/);
                const price = priceMatch ? priceMatch[1] : '';
                
                if (DEBUG) {
                    console.log('[BTO] åŸå§‹:', content);
                    console.log('[BTO] è§£æ: ticker=' + ticker + ', strike=' + strikePrice + ', type=' + optionType + ', expiry=' + expiry + ', price=' + price);
                }
                
                // åˆ¤æ–·å‹•ä½œ
                let action = 'buy';
                let actionText = 'ğŸŸ¢ è²·å…¥';
                
                if (lower.includes('æ­¢æ') || lower.includes('æ­¢æŸ') || lower.includes('æ­¢æŸäº†') || lower.includes('stoploss')) {
                    action = 'loss';
                    actionText = 'ğŸ”´ æ­¢æ';
                } else if (lower.includes('å¹³å€‰') || lower.includes('å¹³ä»“') || lower.includes('close') || lower.includes('all out')) {
                    action = 'close';
                    actionText = 'ğŸ”´ å¹³å€‰';
                } else if (lower.includes('+') && / \+?\d+%/.test(lower)) {
                    action = 'profit';
                    actionText = 'ğŸ’° æ­¢ç›ˆ';
                }
                
                const result = {
                    ticker,
                    strikePrice,
                    optionType,
                    price,
                    action,
                    actionText,
                    expiration: expiry
                };
                if (DEBUG) console.log('[çµæœ] BTOæ ¼å¼:', result);
                return result;
            }
            
            // ========== 4. æª¢æ¸¬ JPM Update æ ¼å¼ ==========
            // æ ¼å¼: 
            // Update SPY 02/10 693P @1.22 (+60%) 
            // æˆ–æ›è¡Œ:
            // Update
            // SPY 02/10 693P @1.22 (+60%)
            // æˆ–:
            // SPY 02/10 693P @1.22 (+60%) ğŸ”¥
            const jpmPattern = /(?:Update\s*[\n\r]+)?([A-Z]{2,})\s+(\d{1,2})\/(\d{1,2})\s+(\d+\.?\d*)([PpCc])\s*@\$?([\d.]+).*?\(?([+\-]?\d+)%\)?/i;
            const jpmMatch = content.match(jpmPattern);
            
            if (jpmMatch) {
                const ticker = jpmMatch[1].toUpperCase();
                const expMonth = jpmMatch[2];
                const expDay = jpmMatch[3];
                const strikePrice = jpmMatch[4];
                const optionType = jpmMatch[5].toUpperCase();
                const price = jpmMatch[6];
                const pnl = parseFloat(jpmMatch[7]);
                
                if (DEBUG) {
                    console.log('[JPM] âœ… åŒ¹é…æˆåŠŸ');
                    console.log('[JPM] è§£æ: ticker=' + ticker + ', expiry=' + expMonth + '/' + expDay + ', strike=' + strikePrice + ', type=' + optionType + ', price=' + price + ', pnl=' + pnl + '%');
                }
                
                return {
                    ticker,
                    strikePrice,
                    optionType,
                    price,
                    action: 'update',
                    actionText: 'ğŸŸ¡ æ›´æ–°',
                    expiration: expMonth + '/' + expDay,
                    pnl: pnl
                };
            }
            
            // ========== 4.2 æª¢æ¸¬ JPM Close æ ¼å¼ ==========
            // æ ¼å¼: 
            // Close SPY 02/10 693P (all out @.81)
            // æˆ–æ›è¡Œ:
            // Close
            // SPY 02/10 693P (all out @.81) ğŸ”¥
            const jpmClosePattern = /(?:Close\s*[\n\r]+)?([A-Z]{2,})\s+(\d{1,2})\/(\d{1,2})\s+(\d+\.?\d*)([PpCc])\s*(?:\([^)]*out.*?@\$?([\d.]+)\)[^)]*\))?\s*[ğŸ”¥]?/i;
            const jpmCloseMatch = content.match(jpmClosePattern);
            
            if (jpmCloseMatch && /close|all out|å¹³å€‰/i.test(content)) {
                const ticker = jpmCloseMatch[1].toUpperCase();
                const expMonth = jpmCloseMatch[2];
                const expDay = jpmCloseMatch[3];
                const strikePrice = jpmCloseMatch[4];
                const optionType = jpmCloseMatch[5].toUpperCase();
                const price = jpmCloseMatch[6] || '';
                
                if (DEBUG) {
                    console.log('[JPM Close] âœ… åŒ¹é…æˆåŠŸ');
                    console.log('[JPM Close] è§£æ: ticker=' + ticker + ', expiry=' + expMonth + '/' + expDay + ', strike=' + strikePrice + ', type=' + optionType + ', price=' + price);
                }
                
                return {
                    ticker,
                    strikePrice,
                    optionType,
                    price,
                    action: 'close',
                    actionText: 'ğŸ”´ å¹³å€‰',
                    expiration: expMonth + '/' + expDay,
                    notes: 'å·²å¹³å€‰'
                };
            }
            
            if (DEBUG && /JpmInvestments/i.test(content)) {
                console.log('[JPM] âŒ æœªåŒ¹é…ï¼Œå®Œæ•´å…§å®¹:', content);
            }
            
            // ========== 5. æª¢æ¸¬ç´”ç²¹ç²åˆ©ç™¾åˆ†æ¯”æ ¼å¼ ==========
            const pnlPattern = /([A-Z]{2,})\s*[+\-](\d+)%/i;
            const pnlMatch = content.match(pnlPattern);
            if (pnlMatch) {
                const result = {
                    ticker: pnlMatch[1].toUpperCase(),
                    strikePrice: '',
                    optionType: '',
                    price: '',
                    action: 'profit',
                    actionText: 'ğŸ’° æ­¢ç›ˆ',
                    expiration: '',
                    pnl: parseFloat(pnlMatch[2])
                };
                if (DEBUG) console.log('[çµæœ] æ­¢ç›ˆä¿¡è™Ÿ:', result);
                return result;
            }
            
            // ========== 6. é»˜èªè¿”å›ä¸€èˆ¬è¨Šæ¯ ==========
            if (DEBUG) console.log('[çµæœ] ä¸€èˆ¬è¨Šæ¯');
            return { ticker: '', action: 'info', actionText: 'ğŸ’¬ è¨Šæ¯' };
        }
        
        function renderMessages() {
            const container = document.getElementById('signal-list');
            
            let filtered = messages;
            
            // éæ¿¾ç„¡æ•ˆ JPM è¨Šæ¯
            filtered = filtered.filter(m => {
                const content = (m.content || '').trim();
                const isInvalid = /^JpmInvestments?\s*[:ï¼š]?\s*@JPM\s*$/i.test(content) ||
                                  /^Jpm\s*$/i.test(content) ||
                                  /^(Unbounded|æ— ç•Œ|Bounded|æœ‰ç•Œ)$/i.test(content);
                if (isInvalid && DEBUG) console.log('[éæ¿¾] ç§»é™¤:', content.substring(0, 30));
                return !isInvalid;
            });
            
            // å…ˆæŒ‰ä¿¡æ¯æµéæ¿¾
            if (currentStream !== 'all') {
                filtered = messages.filter(m => {
                    const channelName = CHANNEL_NAMES[m.channel_id];
                    return channelName === currentStream;
                });
            }
            
            // å†æŒ‰å‹•ä½œéæ¿¾
            if (currentFilter !== 'all') {
                filtered = filtered.filter(m => {
                    const info = parseMessage(m.content);
                    const isTradingCard = m.has_order || (info.ticker && info.action === 'buy');
                    
                    if (!isTradingCard) return currentFilter === 'info';
                    return info.action === currentFilter;
                });
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="no-signals">
                        <div class="no-signals-icon">ğŸ“­</div>
                        <h3>æš«ç„¡è¨Šè™Ÿ</h3>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map((m, idx) => {
                const info = parseMessage(m.content);
                const cardClass = info.action;
                const msgId = m.id || 'msg-' + idx;
                const isUnread = !readIds.has(msgId);
                
                // åˆ¤æ–·æ˜¯å¦ç‚ºäº¤æ˜“å¡ç‰‡ï¼š
                // 1. æœ‰ has_order
                // 2. è§£æå‡º ticker ä¸”æ˜¯è²·å…¥/æ›´æ–°/å¹³å€‰å‹•ä½œ
                const isTradingCard = m.has_order || (info.ticker && ['buy', 'update', 'close'].includes(info.action));
                
                // ä¸€èˆ¬è¨Šæ¯å¡ç‰‡ (æ²’æœ‰äº¤æ˜“è¨‚å–®ä¹Ÿæ²’æœ‰è§£æå‡º OCULUS/JPM æ ¼å¼)
                if (!isTradingCard) {
                    return `
                        <div class="signal-card info ${getChannelClass(m.channel_id)} ${isUnread ? 'new' : 'read'}" 
                             id="card-${msgId}" 
                             title="é»æ“Šå¡ç‰‡æ¨™è¨˜ç‚ºå·±è®€">
                            <div class="signal-header">
                                <div class="signal-meta">
                                    <span class="signal-time">${formatTime(m.timestamp)}</span>
                                    <span class="channel-tag channel-tag-${CHANNEL_NAMES[m.channel_id] || ''}">${getChannelName(m.channel_id)}</span>
                                    ${isUnread ? '<span class="click-hint" id="hint-' + msgId + '">â— æ–°è¨Šæ¯</span>' : ''}
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    ${isUnread ? `<button class="btn-read" onclick="markAsRead('${msgId}')">âœ“ å·±è®€</button>` : ''}
                                    <span class="action-tag info">${info.actionText}</span>
                                </div>
                            </div>
                            <div class="raw-data">
                                <div class="raw-content">${escapeHtml(m.content || '')}</div>
                            </div>
                        </div>
                    `;
                }
                
                // äº¤æ˜“è¨Šæ¯å¡ç‰‡
                const optionType = info.optionType ? info.optionType.toUpperCase() : '';
                const optionClass = optionType === 'C' ? 'call' : (optionType === 'P' ? 'put' : '');
                const optionText = optionType === 'C' ? 'CALL' : (optionType === 'P' ? 'PUT' : '');
                const entryPrice = info.price || '---';
                
                return `
                    <div class="signal-card ${cardClass} ${getChannelClass(m.channel_id)} ${isUnread ? 'new' : 'read'}" 
                         id="card-${msgId}" 
                         title="é»æ“Šå¡ç‰‡æ¨™è¨˜ç‚ºå·±è®€">
                        <div class="signal-header">
                            <div class="signal-meta">
                                <span class="signal-time">${formatTime(m.timestamp)}</span>
                                <span class="channel-tag channel-tag-${CHANNEL_NAMES[m.channel_id] || ''}">${getChannelName(m.channel_id)}</span>
                                ${isUnread ? '<span class="click-hint" id="hint-' + msgId + '">â— æ–°è¨Šæ¯</span>' : ''}
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                ${isUnread ? `<button class="btn-read" onclick="markAsRead('${msgId}')">âœ“ å·±è®€</button>` : ''}
                                <span class="action-tag ${cardClass}">${info.actionText}</span>
                            </div>
                        </div>
                        
                        ${info.ticker ? `
                        <div class="parsed-result" onclick="event.stopPropagation()">
                            <div class="parsed-header">
                                <span class="parsed-ticker">$${info.ticker}</span>
                                <span style="color: ${optionClass === 'call' ? '#4CAF50' : optionClass === 'put' ? '#f44336' : '#888'}; font-weight: bold;">
                                    ${optionText}${optionText && info.expiration ? ' Â· ' : ''}${info.expiration || ''}
                                </span>
                                ${info.pnl ? `<span style="color: ${info.pnl >= 0 ? '#4CAF50' : '#f44336'}; font-weight: bold; margin-left: 8px;">${info.pnl >= 0 ? '+' : ''}${info.pnl}%</span>` : ''}
                            </div>
                            <div class="parsed-details">
                                <div class="detail-box">
                                    <div class="detail-label">å±¥ç´„åƒ¹</div>
                                    <div class="detail-value white">$${info.strikePrice || '---'}</div>
                                </div>
                                <div class="detail-box">
                                    <div class="detail-label">åŸ·è¡Œåƒ¹æ ¼</div>
                                    <div class="detail-value ${cardClass === 'buy' ? 'green' : cardClass === 'update' ? 'orange' : 'blue'}">$${entryPrice}</div>
                                </div>
                                <div class="detail-box">
                                    <div class="detail-label">è¨‚å–®ç‹€æ…‹</div>
                                    <div class="detail-value ${cardClass === 'buy' ? 'green' : cardClass === 'sell' || cardClass === 'close' ? 'red' : cardClass === 'update' ? 'orange' : 'blue'}">
                                        ${info.action === 'buy' ? 'å¾…å¹³å€‰' : info.action === 'update' ? info.notes || 'æ›´æ–°' : info.actionText.replace(/[ğŸŸ¢ğŸ”´ğŸŸ¡]/g, '').trim()}
                                    </div>
                                </div>
                            </div>
                            ${info.notes && !info.pnl ? `
                            <div class="parsed-notes" style="margin-top: 8px; font-size: 0.9em; color: #888;">
                                ğŸ“ ${info.notes}
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        <div class="raw-data">
                            <div class="raw-content">${escapeHtml(m.content || '')}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function formatTime(isoString) {
            if (!isoString) return '-';
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return '-';
                return date.toLocaleString('zh-TW', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch { return '-'; }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // æ¯ 2 ç§’åˆ·æ–°
        setInterval(fetchData, 2000);
        fetchData();
        
        // é–‹å§‹ç›£æ§æ–°è¨Šæ¯ï¼ˆå®¢æˆ¶ç«¯éŸ³æ•ˆï¼‰
        startMessageMonitoring();
        
        // æ›´æ–°æ™‚é–“é¡¯ç¤º
        updateTimes();
        setInterval(updateTimes, 1000);
    </script>
</body>
</html>
